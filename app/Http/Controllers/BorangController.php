<?php

namespace App\Http\Controllers;

use App\Exports\DataBorang;
use App\Exports\DataPermohonan;
use App\Exports\DocumentBorang;
use App\Exports\DocumentBukti;
use App\Exports\ElementBorang;
use App\Identitas;
use App\PermohonanP2kb;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Maatwebsite\Excel\Facades\Excel;
use Ramsey\Uuid\Uuid;

class BorangController extends Controller
{
    public function view_import_dokumen_bukti(){
        return view('import');
    }
    public function ambil_dokument_borang_post(Request $request)
    {
        $datas = Excel::toArray([], $request->file);
        $datas = $datas[0];
        return Excel::download(new DocumentBorang($datas),'Data Dokumen Yang Hilang.xlsx');
    }

    public function ambil_document_bukti()
    {
        $parseDate = Carbon::parse("2016-01-01")->format('Y-m-d');
        $endDate = Carbon::parse("2020-12-31")->format('Y-m-d');
        $data = DB::table('cpd_lampiran_dokumen_m')->where('tgl_dokumen','>=',$parseDate)->select('cpd_lampiran_dokumen_m.*')->orderBy('tgl_dokumen')->get();

        return Excel::download(new DocumentBukti($data),'Data Dokumen Bukti Borang Belum ada 15 April'.'.xlsx');
    }

    public function ambil_permohonan()
    {
        $data = DB::table('cpd_periode_str_m')->where('tgl_selesai','>=','2016-01-01')->orderBy('tgl_selesai','DESC')->get();
        // foreach($data as $item){
        //     $parseDate = Carbon::parse($item->tgl_mulai)->format('Y-m-d H:i:s');
        //     $cekBorang = DB::table('cpd_buku_log_t')->where('id_person',$item->id_person)->where('mdd','>=',$parseDate)->orderBy('id_form')->get();
        //     $item->borang = $cekBorang;
        // }
        return Excel::download(new DataPermohonan($data),'Data Permohonan STR BARU'.' - '. Carbon::now().'.xlsx');
    }
    public function ambil_borang()
    {
        // AMBIL TAHUN 2019
        $parseDate = Carbon::parse("2019-01-01")->format('Y-m-d H:i:s');
        $endDate = Carbon::parse("2019-12-31")->format('Y-m-d H:i:s');
        // $data = DB::table('cpd_buku_log_t')->where('tanggal_kegiatan','=>',$parseDate)->where('tanggal_kegiatan','<=',$endDate)->orderBy('tanggal_kegiatan')->get();
        $datas = DB::select("SELECT * FROM `cpd_buku_log_t` WHERE `id_log` IN (144697,144698,144699,144703,144711,144712,144713,144714,144715,144716,144717,144718,144719,144720,144721,144722,144723,144724,144725,144728,144729,144730,144731,144732,144733,144734,144735,144739,144740,144741,144744,144745,144746,144751,144752,144754,144757,144758,144759,144762,144763,144764,144767,144768,144769,144770,144773,144774,144775,144785,144788,144789,144791,144793,144794,144795,144796,144797,144800,144801,144803,144804,144805,144808,144811,144823,144824,144825,144828,144829,144830,144833,144834,144835,144864,144865,144866,144867,144869,144870,144871,144872,144874,144875,144876,144877,144879,144884,144885,144886,144887,144891,144892,144893,144894,144899,144904,144905,144906,144907,144908,144921,144922,144923,144926,144927,144928,144936,144937,144938,144939,144941,144945,144946,144947,144948,144953,144954,144955,144958,144959,144960,144985,144986,144987,144988,144989,144991,144998,145000,145002,145009,145010,145011,145012,145013,145014,145015,145016,145017,145018,145019,145020,145021,145022,145023,145024,145025,145026,145027,145028,145029,145030,145031,145032,145033,145034,145035,145036,145037,145038,145039,145040,145041,145042,145043,145044,145045,145046,145047,145048,145049,145050,145051,145052,145053,145054,145055,145056,145057,145058,145059,145061,145063,145064,145065,145066,145069,145070,145071,145074,145075,145076,145079,145080,145081,145084,145085,145086,145092,145096,145097,145098,145099,145107,145108,145109,145110,145111,145112,145113,145114,145115,145116,145117,145118,145119,145123,145124,145125,145126,145127,145128,145129,145130,145131,145132,145133,145134,145135,145136,145138,145139,145140,145141,145142,145143,145148,145156,145157,145158,145159,145160,145161,145163,145164,145165,145166,145167,145168,145169,145170,145171,145172,145173,145174,145175,145176,145177,145180,145182,145183,145186,145187,145188,145193,145194,145195,145198,145199,145200,145203,145204,145205,145208,145209,145210,145211,145212,145213,145214,145215,145216,145217,145218,145222,145223,145224,145225,145226,145227,145230,145231,145232,145235,145236,145237,145238,145239,145240,145241,145242,145243,145244,145245,145246,145247,145248,145249,145250,145251,145252,145253,145254,145255,145256,145257,145258,145259,145260,145261,145262,145263,145264,145265,145266,145267,145268,145269,145270,145271,145272,145273,145274,145275,145276,145277,145278,145279,145280,145282,145283,145284,145285,145286,145287,145288,145289,145290,145291,145292,145293,145294,145295,145296,145297,145298,145299,145300,145301,145302,145303,145304,145305,145306,145307,145310,145311,145312,145313,145318,145319,145320,145328,145329,145330,145331,145357,145360,145361,145362,145363,145365,145367,145368,145369,145370,145371,145381,145382,145383,145384,145385,145386,145387,145388,145389,145390,145391,145392,145393,145394,145395,145398,145399,145400,145401,145402,145403,145406,145407,145408,145411,145412,145413,145414,145415,145416,145417,145418,145419,145420,145421,145422,145423,145424,145425,145426,145427,145428,145429,145430,145431,145437,145438,145439,145440,145441,145442,145443,145444,145445,145446,145447,145448,145449,145450,145467,145469,145470,145473,145474,145475,145476,145477,145478,145481,145482,145483,145486,145487,145488,145493,145494,145495,145505,145506,145507,145508,145511,145512,145513,145514,145516,145517,145518,145519,145526,145527,145545,145546,145547,145550,145551,145552,145555,145556,145557,145561,145562,145563,145564,145565,145566,145567,145568,145569,145570,145573,145575,145576,145578,145579,145581,145582,145584,145585,145586,145589,145590,145591,145599,145600,145613,145614,145615,145617,145618,145619,145620,145621,145622,145623,145625,145626,145627,145629,145630,145631,145634,145635,145636,145639,145640,145641,145644,145645,145646,145649,145650,145652,145655,145656,145657,145660,145661,145662,145666,145667,145668,145669,145670,145671,145672,145673,145676,145677,145678,145679,145680,145681,145682,145683,145686,145687,145688,145691,145692,145693,145696,145700,145704,145705,145706,145707,145708,145709,145710,145711,145712,145713,145714,145715,145716,145717,145718,145734,145735,145736,145737,145738,145739,145740,145741,145742,145743,145744,145745,145746,145747,145748,145749,145750,145751,145752,145753,145754,145755,145756,145757,145758,145759,145760,145761,145762,145767,145773,145774,145775,145778,145779,145780,145783,145784,145787,145788,145789,145790,145792,145793,145794,145795,145802,145804,145806,145809,145810,145811,145814,145815,145816,145830,145831,145835,145836,145838,145839,145840,145841,145842,145844,145845,145846,145847,145848,145849,145850,145851,145852,145853,145854,145856,145857,145858,145859,145860,145861,145862,145863,145864,145865,145866,145867,145868,145869,145870,145871,145872,145873,145875,145877,145878,145879,145880,145881,145882,145883,145884,145885,145886,145887,145888,145889,145890,145891,145892,145893,145894,145895,145896,145897,145898,145899,145900,145901,145902,145903,145904,145905,145906,145907,145908,145909,145910,145911,145912,145914,145915,145916,145917,145918,145919,145920,145922,145923,145924,145925,145926,145927,145928,145929,145930,145932,145933,145934,145936,145937,145938,145939,145940,145941,145942,145943,145944,145945,145947,145948,145949,145950,145951,145952,145953,145954,145955,145956,145957,145958,145959,145960,145961,145962,145963,145964,145965,145966,145967,145968,145969,145970,145971,145972,145973,145974,145975,145976,145977,145978,145979,145980,145981,145982,145983,145984,145985,145986,145987,145988,145989,145990,145991,145992,145993,145994,145995,145996,145997,145998,145999,146000,146001,146002,146003,146004,146005,146006,146007,146008,146009,146010,146011,146014,146016,146017,146018,146019,146021,146022,146023,146024,146026,146027,146030,146031,146032,146033,146034,146035,146036,146037,146038,146039,146040,146042,146043,146044,146045,146046,146047,146049,146050,146051,146052,146053,146054,146056,146057,146058,146059,146060,146061,146062,146063,146064,146065,146066,146067,146068,146069,146070,146071,146072,146073,146074,146075,146076,146077,146078,146079,146080,146081,146082,146083,146084,146085,146086,146087,146088,146089,146090,146091,146092,146093,146094,146095,146096,146097,138906,139041,139047,138454,138463,138475,138660,138661,138685,138862,127228) ORDER BY `tanggal_kegiatan` ASC");
        // $datas = DB::select("SELECT `id_log` FROM `cpd_buku_log_t` WHERE `tanggal_kegiatan` >= '2020-01-01'");
        // $datas = DB::select("SELECT * FROM `cpd_buku_log_t` WHERE `evaluated` = 'no' AND `catatan` IS NOT NULL OR `catatan_komisi` IS NOT NULL AND `id_log` IN (144697,144698,144699,144703,144711,144712,144713,144714,144715,144716,144717,144718,144719,144720,144721,144722,144723,144724,144725,144728,144729,144730,144731,144732,144733,144734,144735,144739,144740,144741,144744,144745,144746,144751,144752,144754,144757,144758,144759,144762,144763,144764,144767,144768,144769,144770,144773,144774,144775,144785,144788,144789,144791,144793,144794,144795,144796,144797,144800,144801,144803,144804,144805,144808,144811,144823,144824,144825,144828,144829,144830,144833,144834,144835,144864,144865,144866,144867,144869,144870,144871,144872,144874,144875,144876,144877,144879,144884,144885,144886,144887,144891,144892,144893,144894,144899,144904,144905,144906,144907,144908,144921,144922,144923,144926,144927,144928,144936,144937,144938,144939,144941,144945,144946,144947,144948,144953,144954,144955,144958,144959,144960,144985,144986,144987,144988,144989,144991,144998,145000,145002,145009,145010,145011,145012,145013,145014,145015,145016,145017,145018,145019,145020,145021,145022,145023,145024,145025,145026,145027,145028,145029,145030,145031,145032,145033,145034,145035,145036,145037,145038,145039,145040,145041,145042,145043,145044,145045,145046,145047,145048,145049,145050,145051,145052,145053,145054,145055,145056,145057,145058,145059,145061,145063,145064,145065,145066,145069,145070,145071,145074,145075,145076,145079,145080,145081,145084,145085,145086,145092,145096,145097,145098,145099,145107,145108,145109,145110,145111,145112,145113,145114,145115,145116,145117,145118,145119,145123,145124,145125,145126,145127,145128,145129,145130,145131,145132,145133,145134,145135,145136,145138,145139,145140,145141,145142,145143,145148,145156,145157,145158,145159,145160,145161,145163,145164,145165,145166,145167,145168,145169,145170,145171,145172,145173,145174,145175,145176,145177,145180,145182,145183,145186,145187,145188,145193,145194,145195,145198,145199,145200,145203,145204,145205,145208,145209,145210,145211,145212,145213,145214,145215,145216,145217,145218,145222,145223,145224,145225,145226,145227,145230,145231,145232,145235,145236,145237,145238,145239,145240,145241,145242,145243,145244,145245,145246,145247,145248,145249,145250,145251,145252,145253,145254,145255,145256,145257,145258,145259,145260,145261,145262,145263,145264,145265,145266,145267,145268,145269,145270,145271,145272,145273,145274,145275,145276,145277,145278,145279,145280,145282,145283,145284,145285,145286,145287,145288,145289,145290,145291,145292,145293,145294,145295,145296,145297,145298,145299,145300,145301,145302,145303,145304,145305,145306,145307,145310,145311,145312,145313,145318,145319,145320,145328,145329,145330,145331,145357,145360,145361,145362,145363,145365,145367,145368,145369,145370,145371,145381,145382,145383,145384,145385,145386,145387,145388,145389,145390,145391,145392,145393,145394,145395,145398,145399,145400,145401,145402,145403,145406,145407,145408,145411,145412,145413,145414,145415,145416,145417,145418,145419,145420,145421,145422,145423,145424,145425,145426,145427,145428,145429,145430,145431,145437,145438,145439,145440,145441,145442,145443,145444,145445,145446,145447,145448,145449,145450,145467,145469,145470,145473,145474,145475,145476,145477,145478,145481,145482,145483,145486,145487,145488,145493,145494,145495,145505,145506,145507,145508,145511,145512,145513,145514,145516,145517,145518,145519,145526,145527,145545,145546,145547,145550,145551,145552,145555,145556,145557,145561,145562,145563,145564,145565,145566,145567,145568,145569,145570,145573,145575,145576,145578,145579,145581,145582,145584,145585,145586,145589,145590,145591,145599,145600,145613,145614,145615,145617,145618,145619,145620,145621,145622,145623,145625,145626,145627,145629,145630,145631,145634,145635,145636,145639,145640,145641,145644,145645,145646,145649,145650,145652,145655,145656,145657,145660,145661,145662,145666,145667,145668,145669,145670,145671,145672,145673,145676,145677,145678,145679,145680,145681,145682,145683,145686,145687,145688,145691,145692,145693,145696,145700,145704,145705,145706,145707,145708,145709,145710,145711,145712,145713,145714,145715,145716,145717,145718,145734,145735,145736,145737,145738,145739,145740,145741,145742,145743,145744,145745,145746,145747,145748,145749,145750,145751,145752,145753,145754,145755,145756,145757,145758,145759,145760,145761,145762,145767,145773,145774,145775,145778,145779,145780,145783,145784,145787,145788,145789,145790,145792,145793,145794,145795,145802,145804,145806,145809,145810,145811,145814,145815,145816,145830,145831,145835,145836,145838,145839,145840,145841,145842,145844,145845,145846,145847,145848,145849,145850,145851,145852,145853,145854,145856,145857,145858,145859,145860,145861,145862,145863,145864,145865,145866,145867,145868,145869,145870,145871,145872,145873,145875,145877,145878,145879,145880,145881,145882,145883,145884,145885,145886,145887,145888,145889,145890,145891,145892,145893,145894,145895,145896,145897,145898,145899,145900,145901,145902,145903,145904,145905,145906,145907,145908,145909,145910,145911,145912,145914,145915,145916,145917,145918,145919,145920,145922,145923,145924,145925,145926,145927,145928,145929,145930,145932,145933,145934,145936,145937,145938,145939,145940,145941,145942,145943,145944,145945,145947,145948,145949,145950,145951,145952,145953,145954,145955,145956,145957,145958,145959,145960,145961,145962,145963,145964,145965,145966,145967,145968,145969,145970,145971,145972,145973,145974,145975,145976,145977,145978,145979,145980,145981,145982,145983,145984,145985,145986,145987,145988,145989,145990,145991,145992,145993,145994,145995,145996,145997,145998,145999,146000,146001,146002,146003,146004,146005,146006,146007,146008,146009,146010,146011,146014,146016,146017,146018,146019,146021,146022,146023,146024,146026,146027,146030,146031,146032,146033,146034,146035,146036,146037,146038,146039,146040,146042,146043,146044,146045,146046,146047,146049,146050,146051,146052,146053,146054,146056,146057,146058,146059,146060,146061,146062,146063,146064,146065,146066,146067,146068,146069,146070,146071,146072,146073,146074,146075,146076,146077,146078,146079,146080,146081,146082,146083,146084,146085,146086,146087,146088,146089,146090,146091,146092,146093,146094,146095,146096,146097,138906,139041,139047,138454,138463,138475,138660,138661,138685,138862,127228) ORDER BY `cpd_buku_log_t`.`tgl_verifikasi` DESC");
        foreach($datas as $borang){
            $cekBorang              = DB::table('cpd_form_m')->where('id_form',$borang->id_form)->first();
            $namaKegiatan           = DB::table('cpd_kegiatan_m')->where('id_kegiatan',$cekBorang->id_kegiatan)->pluck('nama')->first();
            $borang->nama_kegiatan  = $namaKegiatan;
        }
        return Excel::download(new DataBorang($datas),'BORANG 15 APRIL 2021'.'.xlsx');
    }
    public function ambil_document_borang()
    {
        $data = DB::table('cpd_dokumen_bukti_t')->LeftJoin('cpd_buku_log_t','cpd_buku_log_t.id_log','cpd_dokumen_bukti_t.id_log')->select('cpd_dokumen_bukti_t.*','cpd_buku_log_t.tanggal_kegiatan')->orderBy('cpd_dokumen_bukti_t.mdb')->get();
        return Excel::download(new DocumentBorang($data),'Data Dokumen Bukti '.' - 15 APRIL 2021'.'.xlsx');
    }
    public function ambil_element()
    {
        $data = DB::table('cpd_elemen_m')->orderBy('id_form','ASC')->orderBy('elemen_sort','ASC')->select('id_form','tipe','label','elemen_sort','is_required','is_parameter','is_engine','formulation','related_engine as skp_engine')->take(1)->get();
        dd($data);
        foreach ($data as $item){
            $idForm = DB::table('cpd_form_m')->where('id_form',$item->id_form)->first();
            $idBorang = DB::table('cpd_kegiatan_m')->where( 'id_kegiatan',$idForm->id_kegiatan)->first();
            $item->form_detail = $idForm;
            $item->borang_detail = $idBorang;
            $item->nama_kegiatan = $idBorang->nama;
        }
        return Excel::download(new ElementBorang($data),'Element Borang'.' - '. Carbon::now().'.xlsx');
    }
    public function view_import_permohonan(){
        return view('admin.import-permohonan');
    }
    public function import_permohonan(Request $request){
        $datas = Excel::toArray([], $request->file);
        $array = [];
        foreach($datas[0] as $key => $data){
            if($key !== 0){
                $array[] =  $data;
            }
        }
        foreach($array as $item){
            $id_unik = $item[1];
            PermohonanP2kb::create([
                'id'                    => $id_unik,
                'user_id'               => $item[2],
                'str_number'            => $item[3],
                'name'                  => "",
                'birth_place'           => "",
                'birth_date'            => "",
                'sex'                   => "",
                'competence'            => "",
                'date_graduation'       => "",
                'university'            => "",
                'start_date'            => $item[6],
                'is_deleted'            => 0,
                'end_date'              => $item[7],
            ]);
        }

    }
}
